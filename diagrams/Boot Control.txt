sequenceDiagram
  title Boot Control Detailed

  participant U as Operator
  participant GCS as GCS MAVLink
  participant LORA as LoRa Link
  participant FC as Flight Controller STM32F411
  participant RPI as Raspberry Pi Vision Logging
  participant ACT as Actuators Servos
  participant ESC as ESC
  participant MOT as Thrust Motor

  U ->> GCS: Power ON system
  GCS ->> LORA: Start heartbeat
  LORA ->> FC: Heartbeat stream

  FC ->> FC: MCU boot and init clocks timers DMA
  FC ->> FC: Load parameters from flash
  FC ->> FC: Load calibration constants

  FC ->> RPI: Init companion link UART or USB TBD
  RPI -->> FC: RPI status READY or NOT READY

  FC ->> FC: Sensor self test IMU GPS BARO
  FC ->> ACT: Pre arm surface test limited safe
  ACT -->> FC: Actuators OK or FAIL
  FC ->> ESC: Pre arm check throttle zero
  ESC -->> FC: ESC OK or FAIL
  ESC ->> MOT: Motor disarmed

  FC ->> LORA: Status report params sensors rpi
  LORA ->> GCS: Status report params sensors rpi
  GCS ->> U: Show boot summary and RPI status

  alt Boot checks OK
    FC ->> LORA: STATE WAITING_FOR_MISSION
    LORA ->> GCS: STATE WAITING_FOR_MISSION
    GCS ->> U: Display WAITING_FOR_MISSION
  else Boot checks FAIL
    FC ->> LORA: STATE ERROR_BOOT plus reason
    LORA ->> GCS: STATE ERROR_BOOT plus reason
    GCS ->> U: Display ERROR_BOOT
  end

  opt Mission upload required
    U ->> GCS: Upload mission
    GCS ->> LORA: MAVLink mission upload stream
    LORA ->> FC: Mission items
    FC -->> LORA: Mission ack
    LORA -->> GCS: Mission ack
    GCS ->> U: Mission upload OK
  end

  alt Mission received and stored
    FC ->> LORA: STATE READY_TO_START
    LORA ->> GCS: STATE READY_TO_START
    GCS ->> U: Display READY_TO_START
  else Mission missing or invalid
    FC ->> LORA: STATE NOT_READY plus reason
    LORA ->> GCS: STATE NOT_READY plus reason
    GCS ->> U: Display NOT_READY
  end
